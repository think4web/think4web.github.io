---
published: false
layout: post
title: Google Tag Manager. Активація Facebook Pixel за таймером
tags: google-tag-manager 
discription: Налаштування запуску Facebook Pixel за таймером через Google Tag Manager для користувачів з зовнішнього сайту або за прямими заходами.
---

За ТЗ потрібно щоб піксель facebook завантажувався з затримкою (10 секунд) і тільки якщо користувач прийшов з зовнішнього сайту (referral) або заходив, набираючи адресу сайту в адресному рядку (direct). Але завантажувався без затримки при внутрішніх переходах між сторінками сайту.

Складність тут полягає саме в прямих заходах (direct). Тому що відстежити зовнішній перехід легко (URL сайту-джерела не співпадатиме з нашим доменом), як і внутрішні переходи (URL сайту-джерела буде збігатися з нашим доменом). Але при прямому переході на сайт немає ніякого сайту-джерела.

## Рішення

Щоб вирішити цю проблему потрібно використовувати скрипт. Нижче дам посилання на нього. Якщо коротко описати його роботу, то він перевіряє джерело переходу і повертає три значення:
- якщо перехід внутрішній - false;
- якщо перехід реферальний - ім'я домену з якого прийшов користувач;
- якщо прямий візит на сайт - direct.

## Встановлення скрипта

Потрібно створити в GTM змінну типу “Custom JavaScript”. Вставляємо в неї наступний код:

```js
function(){

  var o = ‘your_site’;

  var s = false;

  var r = document.referrer;

  if( r.indexOf(o) < 0 ){

    var url = document.createElement('a');

    url.href = r;

    s = ( document.referrer == '' ) ? 'direct' : url.hostname ;

  }

  return s;

}
```
Назвати змінну можна як хочеться. Я назвав "direct".

Використовую такі налаштування для пікселя:

![Налаштування Facebook Pixel](/images/Google-Tag-Manager-vykorystannya-taymera-dlya-pikselya-facebook-1.png)

Перший тригер - просто перегляд сторінок. Це активує тег пікселя при внутрішніх переходах.

Другий тригер - таймер, з відтермінуванням в 10 секунд.

Дуже важливо, що тригери використовуються з умовою "OR". Тобто, спрацьовує перший або другий тригер, але не обидва відразу. Тепер налаштування таймера.

![Налаштування таймера в Google Tag Manager](/images/Google-Tag-Manager-vykorystannya-taymera-dlya-pikselya-facebook-2.png)

Змінна "direct" - це той самий скрипт.

Вся ця затія потрібна для того, щоб не фіксувати користувачів, які провели на сайті менше 10 секунд. Користувачів, які мало зацікавлені в утриманні сайту або випадково на нього попавши.

Я б збирав користувачів, які виявили різну активність на сайті, трохи інакше. Замість пікселя я б використав дії - конверсії (мікро-конверсію, тоді як цільове дію буде макро-конверсією) і аудиторії. Наприклад, таймер запускав б тег конверсії після того, як користувач провів певний час на сайті. Або конверсію, якщо користувач переглянув кілька сторінок за сеанс. Конверсію при певній глибині скролінгу. Звичайно, краще з самого початку почати збирати аудиторії і вже пізніше, коли було отримано достатньо конверсій, дивитися чи є кореляції аудиторії вчинили макро-конверсію з зібраними аудиторіями по мікро-переходів.

Скрипт брав [тут](https://prometriki.ru/fiksaciy-istochnika-perehoda-v-google-tag-manager/).

